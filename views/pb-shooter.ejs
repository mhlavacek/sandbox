<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>HTML5 boilerplate – all you really need…</title>
  <link rel="stylesheet" href="css\app.css">
  <!--[if IE]>
  	<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <style type="text/css">

  </style>
</head>

<body>
  <script type="text/javascript" src="js\vendor\jquery-1.11.1.min.js"></script>
  <script type="text/javascript" src="js\vendor\knockout-3.2.0.js"></script>
  <script type="text/javascript" src="js\vendor\jquery.form.min.js"></script>
  <script type="text/javascript" src="js\vendor\d3.v3.min.js" charset="utf-8"></script>
  <script type="text/javascript" src="js\game.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  
  <div id="screen" style="width: 1400px; height: 500px; border: 1px solid black; margin-top: 10px; margin-left: 10px;">
  </div>
  
  <script>
    $(function() {
      var Game = require('Game');

      var io = window.io.connect(window.location.origin);
      var game = new Game();
      var field = d3.select('#screen').append('svg');

      io.on('tick', function(gameState) {
        game.sync(gameState);
      });

      window.setInterval(function() {
        game.tick();
        render(game.state);
      }, 16);

      function render(gameState) {
        updateBugs(gameState.bugs);
      }

      function updateBugs(bugs) {
        field.selectAll('image.bug').remove();
        var bugSprites = field.selectAll('image.bug').data(bugs);
        bugSprites.enter()
          .append('image');
        
        bugSprites
          .attr('class', 'bug')
          .attr('xlink:href', 'images/bug.png')
          .attr('height', 25)
          .attr('width', 25)
          .attr('transform', function(d) { return buildTransformString(d.position.x - d.drawOffset.x, d.position.y - d.drawOffset.y, d.angle, d.drawOffset.x, d.drawOffset.y); });
      }

      function buildTransformString(x, y, angle, rotateX, rotateY) {
        return "translate( " + x + "," + y + ") rotate(" + angle + " " + rotateX + " " + rotateY + ")";
      }

      window.game = game;
    });
  </script>
</body>
</html>